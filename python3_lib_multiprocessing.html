<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8" />
        <title>python库介绍-multiprocessing：多进程</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">python自动化测试人工智能 </a></h1>
                <nav><ul>
                    <li><a href="/category/ce-shi.html">测试</a></li>
                    <li><a href="/category/ce-shi-kuang-jia.html">测试框架</a></li>
                    <li><a href="/category/common.html">common</a></li>
                    <li><a href="/category/feng-shui.html">风水</a></li>
                    <li><a href="/category/ji-qi-xue-xi.html">机器学习</a></li>
                    <li><a href="/category/linux.html">linux</a></li>
                    <li class="active"><a href="/category/python.html">python</a></li>
                    <li><a href="/category/shu-ji.html">书籍</a></li>
                    <li><a href="/category/shu-ju-fen-xi.html">数据分析</a></li>
                    <li><a href="/category/zhong-cao-yao.html">中草药</a></li>
                    <li><a href="/category/zhong-yi.html">中医</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/python3_lib_multiprocessing.html" rel="bookmark"
           title="Permalink to python库介绍-multiprocessing：多进程">python库介绍-multiprocessing：多进程</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-03-21T19:20:00+08:00">
                Published: 三 21 三月 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/andrew.html">andrew</a>
        </address>
<p>In <a href="/category/python.html">python</a>.</p>

</footer><!-- /.post-info -->      <h2 id="_1">简介</h2>
<p>进程是运行的程序，每个进程有自己的系统状态，包含了内存、打开文件列表、程序计数器（跟踪执行的指令）、存储函数本地调用变量的堆栈。</p>
<p>使用os或subprocess可以创建新进程，比如：os.fork(), subprocess.Popen()。子进程和父进程是相互独立执行的。</p>
<p>interprocess communication (IPC)进程间的通信: 最常见的形式是基于消息传递（message passing）。message是原始字节的缓存，通过I/O channel比如网络socket和管道，使用原语比如send() and recv()来发送接收消息。次常用的有内存映射区：memory-mapped regions，见mmap模块，实际上是共享内存。</p>
<p>线程有自己的控制流和执行堆栈，但是共享系统资源和数据。</p>
<p>并发的难点：同步和数据共享。解决的方法一般是使用互斥锁。</p>
<div class="highlight"><pre><span></span><span class="n">write_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
<span class="o">...</span>
<span class="c1"># Critical section where writing occurs</span>
<span class="n">write_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Here&#39;s some data.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Here&#39;s more data.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">write_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>


<h2 id="python">python的并发程序设计</h2>
<p>多数系统上，Python支持消息传递和基于线程的并发程序设计。global interpreter lock (the GIL)机制实际每个时间单元只允许单个线程执行，哪怕有多个CPU。如果瓶颈在I/O，使用多线程效果不错；如果在cpu，效果则会更差。还不如使用子进程和消息传递。线程数一多经常出现以下怪异的问题，比如100个线程工作良好，1000个线程就可能出问题了，这种情况一般需要使用异步事件处理系统，比如中央事件循环可能使用select模块监控I/O资源和分发异步到大量的I/O 处理器。asyncore和流行的第三方的Twisted (http://twistedmatrix/com)可以实现这点。</p>
<p>消息传递在python使用很广，甚至在线程中。它难于出错，减少了锁和同步原语的使用。可以扩展至网络和分布式系统。Python的高级特性比如协程序（coroutines）也使用消息传递抽象。</p>
<p>multiprocessing支持子进程、通信和共享数据、执行不同形式的同步。</p>
<h2 id="multiprocessing">multiprocessing</h2>
<h3 id="process">Process类</h3>
<p>这个类表示子进程中运行的任务：Process([group [, target [, name [, args [, kwargs]]]]])，构造函数中必须使用关键字参数，target表示可调用对象，args表示调用对象的位置参数元组。kwargs表示调用对象的字典。Name为别名。Group实质上不使用。</p>
<p>方法有：is_alive()、.join([timeout])、run()、start()、terminate()。</p>
<p>属性有：authkey、daemon（要通过start()设置）、exitcode(进程在运行时为None、如果为–N，表示被信号N结束）、name、pid。</p>
<p>Process类中，注意daemon是父进程终止后自动终止，且自己不能产生新进程，必须在start()之前设置。</p>
<p>创建函数并将其作为单个进程。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">clock</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;The time is {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">clock</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>将进程定义为类：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">ClockProcess</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;The time is {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ClockProcess</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>注意，要在命令行才能执行，用IDE是不行的。</p>
<h3 id="_2">进程通信</h3>
<p>multiprocessing支持管道和队列，都是用消息传递来实现的，队列接口和线程中的队列类似。</p>
<p>Queue([maxsize])：默认不限制大小，队列实质是用管道和锁来实现的。支持线程会给底层管道传送数据。</p>
<p>方法有：cancel_join_thread()、close()、empty()、full()、get([block [, timeout]])、get_nowait()（等同于get(False)）、join_thread()、put(item [, block [, timeout]])、put_nowait(item)（等同于put(item, False)）、qsize()、JoinableQueue([maxsize])、task_done()、join()</p>
<p>下例使用队列进行通信：</p>
<p>JoinableQueue创建连接的进程队列。队列和普通队列基本一样，不过消费者在处理完毕之后可以通知生产者（q.task_done()）。使用共享信号和条件变量实现。join()由生产者使用，等待所有成员都收到task_done。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>


<span class="k">def</span> <span class="nf">consumer</span><span class="p">(</span><span class="n">input_q</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">input_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">input_q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">producer</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">output_q</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
        <span class="n">output_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">JoinableQueue</span><span class="p">()</span>
    <span class="n">cons_p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">consumer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
    <span class="n">cons_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">cons_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">producer</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>这里控制多进程的关键在于队列get()之后，使用task_done()指示该元素处理完毕；进程启动之前设置了daemon为True；对队列使用join()。</p>
<p>这种方法可以启动多个进程，如下：</p>
<div class="highlight"><pre><span></span>    <span class="n">process</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">JoinableQueue</span><span class="p">()</span>

    <span class="c1"># Launch the consumer process</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">consumer</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span><span class="n">lock</span><span class="p">))</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
        <span class="n">process</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">process</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">producer</span><span class="p">(</span> <span class="n">key_list</span> <span class="p">)</span>

    <span class="n">key_list</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>下面有个应用实例：</p>
<p>https://bitbucket.org/china-testing/small_python_daily_tools/src/87d81739633482abdd3a2d0d11f62f6edd989555/db/mysql/check_transfer.py?at=default&amp;fileviewer=file-view-default </p>
<p>在某些程序中，生产者需要告知消费者没有更多项目了，消费者可以关闭了。这时需要使用哨兵（sentinel）。</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># multiprocessing_sentinel.py</span>
<span class="c1"># Author Rongzhong Xu 2016-08-11 wechat: pythontesting</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">multiprocessing sentinel demo,</span>
<span class="sd">Tesed in python2.7/3.5/2.6</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>


<span class="k">def</span> <span class="nf">consumer</span><span class="p">(</span><span class="n">input_q</span><span class="p">):</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">input_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># Process item</span>
        <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>  <span class="c1"># Replace with useful work</span>

    <span class="c1"># Shutdown</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Consumer done&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">producer</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">output_q</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
        <span class="c1"># Put the item on the queue</span>
        <span class="n">output_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="c1"># Launch the consumer process</span>
    <span class="n">cons_p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">consumer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
    <span class="n">cons_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># Produce items</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">producer</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="c1"># Signal completion by putting the sentinel on the queue</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="c1"># Wait for the consumer process to shutdown</span>
    <span class="n">cons_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>注意：每个消费者都需要一个：sentinel，可以使用for语句来实现</p>
<div class="highlight"><pre><span></span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</pre></div>


<p>实际使用中不局限于使用None，使用其他特殊符号等也是可以的。上面程序从表面看比使用JoinableQueue要复杂，实现的效果又是一样的。实际上这种场景应用更广泛，在consumer比较耗时的情况下，JoinableQueue如果锁住整个函数则互相等待的时间太长，如果不锁，后面几次执行可能丢失数据。</p>
<h3 id="_3">管道</h3>
<p>使用管道：Pipe([duplex])，返回值：元组(conn1, conn2)。conn1和conn2为Connection对象，代表管道的末端。管道默认是双向的，如果设置duplex为False，conn1只能接收，conn2只能发送。</p>
<p>Connection对象的方法和属性如下：</p>
<p>close()、fileno()、poll([timeout])、recv()、recv_bytes([maxlength]）、recv_bytes_into(buffer [, offset])、send(obj)、send_bytes(buffer [, offset [, size]])</p>
<p>下面例子实现和之前类似的功能：</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">consumer</span><span class="p">(</span><span class="n">pipe</span><span class="p">):</span>
    <span class="n">output_p</span><span class="p">,</span> <span class="n">input_p</span> <span class="o">=</span> <span class="n">pipe</span>
    <span class="n">input_p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the input end of the pipe</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">output_p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># Process item</span>
        <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>  <span class="c1"># Replace with useful work</span>
        <span class="c1"># Shutdown</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Consumer done&quot;</span><span class="p">)</span>

<span class="c1"># Produce items and put on a queue. sequence is an</span>
<span class="c1"># iterable representing items to be processed.</span>


<span class="k">def</span> <span class="nf">producer</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">input_p</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
        <span class="c1"># Put the item on the queue</span>
        <span class="n">input_p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="p">(</span><span class="n">output_p</span><span class="p">,</span> <span class="n">input_p</span><span class="p">)</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
    <span class="c1"># Launch the consumer process</span>
    <span class="n">cons_p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="n">consumer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">((</span><span class="n">output_p</span><span class="p">,</span> <span class="n">input_p</span><span class="p">),))</span>
    <span class="n">cons_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># Close the output pipe in the producer</span>
    <span class="n">output_p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Produce items</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">producer</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">input_p</span><span class="p">)</span>
    <span class="c1"># Signal completion by closing the input pipe</span>
    <span class="n">input_p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Wait for the consumer process to shutdown</span>
    <span class="n">cons_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>管道还可以用于双向通信，比如下例的C/S模式：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="c1"># A server process</span>


<span class="k">def</span> <span class="nf">adder</span><span class="p">(</span><span class="n">pipe</span><span class="p">):</span>
    <span class="n">server_p</span><span class="p">,</span> <span class="n">client_p</span> <span class="o">=</span> <span class="n">pipe</span>
    <span class="n">client_p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">server_p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
        <span class="n">server_p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c1"># Shutdown</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Server done&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="p">(</span><span class="n">server_p</span><span class="p">,</span> <span class="n">client_p</span><span class="p">)</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
    <span class="c1"># Launch the server process</span>
    <span class="n">adder_p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="n">adder</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">((</span><span class="n">server_p</span><span class="p">,</span> <span class="n">client_p</span><span class="p">),))</span>
    <span class="n">adder_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># Close the server pipe in the client</span>
    <span class="n">server_p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Make some requests on the server</span>
    <span class="n">client_p</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">client_p</span><span class="o">.</span><span class="n">recv</span><span class="p">())</span>
    <span class="n">client_p</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="s1">&#39;World&#39;</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">client_p</span><span class="o">.</span><span class="n">recv</span><span class="p">())</span>
    <span class="c1"># Done. Close the pipe</span>
    <span class="n">client_p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Wait for the consumer process to shutdown</span>
    <span class="n">adder_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>send()和recv()使用pickle序列化对象。更高级的程序需要使用远程过程调用，需要使用到进程池。</p>
<h3 id="_4">进程池</h3>
<p>Pool类在简单的情况下可用于管理固定数量的消费者。进程池的功能和列表解析及函数式编程中的map-reduce类似。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">do_calculation</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">start_process</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># convert range to list for python3</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">builtin_outputs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">do_calculation</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

    <span class="c1"># convert to list for python3</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Built-in: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">builtin_outputs</span><span class="p">)))</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">)</span>

    <span class="n">pool_size</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">pool_size</span><span class="p">,</span>
                                <span class="n">initializer</span><span class="o">=</span><span class="n">start_process</span><span class="p">,</span>
                                <span class="p">)</span>
    <span class="n">pool_outputs</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">do_calculation</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># no more tasks</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>  <span class="c1"># wrap up current tasks</span>
    <span class="n">time3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Pool    : {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pool_outputs</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">time3</span> <span class="o">-</span> <span class="n">time2</span><span class="p">)</span>
</pre></div>


<p>执行结果：</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python3</span> <span class="n">multiprocessing_pool</span><span class="o">.</span><span class="n">py</span> 
<span class="n">Built</span><span class="o">-</span><span class="ow">in</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">198</span><span class="p">]</span>
<span class="mf">3.790855407714844e-05</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">2</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">3</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">4</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">5</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">6</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">7</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">9</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">10</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">11</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">12</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">13</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">14</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">15</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">16</span>
<span class="n">Pool</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">198</span><span class="p">]</span>
<span class="mf">0.2203056812286377</span>
</pre></div>


<p>上面例子先计算map的时间，然后用进程池的map，计算出时间。在列表数比较少的情况下，多进程的执行时间更短。列表数比较多的情况下，多进程的执行时间更长，可见python内置的map是效率比较高的。</p>
<p>如果消费者函数有内存泄露，可以在执行任务之后重启，设定maxtasksperchild参数即可。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">do_calculation</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">start_process</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># convert range to list for python3</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

    <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">builtin_outputs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">do_calculation</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

    <span class="c1"># convert to list for python3</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Built-in: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">builtin_outputs</span><span class="p">)))</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="p">)</span>

    <span class="n">pool_size</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">pool_size</span><span class="p">,</span>
                                <span class="n">initializer</span><span class="o">=</span><span class="n">start_process</span><span class="p">,</span>
                                <span class="n">maxtasksperchild</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="p">)</span>
    <span class="n">pool_outputs</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">do_calculation</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># no more tasks</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>  <span class="c1"># wrap up current tasks</span>
    <span class="n">time3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Pool    : {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pool_outputs</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">time3</span> <span class="o">-</span> <span class="n">time2</span><span class="p">)</span>
</pre></div>


<p>执行结果：</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python3</span> <span class="n">multiprocessing_pool2</span><span class="o">.</span><span class="n">py</span> 
<span class="n">Built</span><span class="o">-</span><span class="ow">in</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">198</span><span class="p">]</span>
<span class="mf">3.600120544433594e-05</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">3</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">2</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">4</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">5</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">6</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">7</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">9</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">10</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">11</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">12</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">13</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">14</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">15</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">16</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">17</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">18</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">19</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">20</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">21</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">22</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">23</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">24</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">25</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">26</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">27</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">28</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">29</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">30</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">31</span>
<span class="n">Starting</span> <span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">32</span>
<span class="n">Pool</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">198</span><span class="p">]</span>
<span class="mf">0.23842501640319824</span>
</pre></div>


<p>从结果看，进程数有所增加。(注意，进程数似乎比预期的要少)</p>
<p>Pool([numprocess [,initializer [, initargs]]])</p>
<p>numprocess的默认值是cpu_count()。方法有：apply(func [, args [, kwargs]]),apply_async(func [, args [, kwargs [, callback]]]),close(),join(),imap(func, iterable [, chunksize]),imap_unordered(func, iterable [, chunksize]]),map(func, iterable [, chunksize]),map_async(func, iterable [, chunksize [, callback]]),terminate().</p>
<p>返回结果AsyncResult的方法：get([timeout])、ready()、sucessful()、wait([timeout])、wait([timeout])</p>
<p>以下代码生成指定目录的文件名和SHA512对应表的字典。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">binascii</span>

<span class="c1"># Some parameters you can tweak</span>
<span class="n">BUFSIZE</span> <span class="o">=</span> <span class="mi">8192</span>              <span class="c1"># Read buffer size</span>
<span class="n">POOLSIZE</span> <span class="o">=</span> <span class="mi">2</span>                <span class="c1"># Number of workers</span>


<span class="k">def</span> <span class="nf">compute_digest</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BUFSIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">digest</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">filename</span><span class="p">,</span> <span class="n">digest</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">build_digest_map</span><span class="p">(</span><span class="n">topdir</span><span class="p">):</span>
    <span class="n">digest_pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">POOLSIZE</span><span class="p">)</span>
    <span class="n">allfiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">topdir</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>
    <span class="n">digest_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">digest_pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">compute_digest</span><span class="p">,</span> <span class="n">allfiles</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">digest_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">digest_map</span>

<span class="c1"># Try it out. Change the directory name as desired.</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">digest_map</span> <span class="o">=</span> <span class="n">build_digest_map</span><span class="p">(</span><span class="s2">&quot;/home/andrew/data/code/python/</span><span class="se">\</span>
<span class="s2">python-chinese-library/libraries/multiprocessing&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digest_map</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">digest_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0}： {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">digest_map</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
</pre></div>


<h3 id="_5">共享数据和同步</h3>
<p>共享内存通过mmap实现。共享内存中创建的是ctypes对象，不需要管道中的序列化。</p>
<p>Value(typecode, arg1, ... argN, lock),RawValue(typecode, arg1, ..., argN),Array(typecode, initializer, lock),RawArray(typecode, initializer)</p>
<p>原语有:    Lock，Rlock,Semaphore,BoundedSemaphore,Event,Condition.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>


<span class="k">class</span> <span class="nc">FloatChannel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">RawArray</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_len</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>              <span class="c1"># Only proceed if buffer empty</span>
        <span class="n">nitems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_len</span> <span class="o">=</span> <span class="n">nitems</span>          <span class="c1"># Set the buffer size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">nitems</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>     <span class="c1"># Copy values into the buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>               <span class="c1"># Signal that buffer is full</span>

    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>               <span class="c1"># Only proceed if buffer full</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_len</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>    <span class="c1"># Copy values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>              <span class="c1"># Signal that buffer is empty</span>
        <span class="k">return</span> <span class="n">values</span>

<span class="c1"># Performance test. Receive a bunch of messages</span>


<span class="k">def</span> <span class="nf">consume_test</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

<span class="c1"># Performance test. Send a bunch of messages</span>


<span class="k">def</span> <span class="nf">produce_test</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">ch</span> <span class="o">=</span> <span class="n">FloatChannel</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">consume_test</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">)]</span>
    <span class="n">produce_test</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<h2 id="_6">参考资料</h2>
<ul>
<li><a href="https://github.com/china-testing/python-api-tesing/blob/master/books.md">本文相关书籍下载</a></li>
<li>python测试等IT技术支持qq群144081101(后期会录制视频存在该群群文件) 591302926 567351477 </li>
<li>道家技术-手相手诊看相中医等钉钉群21734177 qq群：391441566 184175668 338228106 看手相、面相、舌相、抽签、体质识别。服务费50元每人次起。请联系钉钉或者微信pythontesting</li>
<li><a href="https://china-testing.github.io/python3_lib_multiprocessing.html">本文最新版本地址</a></li>
<li><a href="https://github.com/china-testing/python-api-tesing">本文涉及的python测试开发库</a> 谢谢点赞！</li>
<li><a href="https://china-testing.github.io/testing_training.html">接口自动化性能测试线上培训大纲</a></li>
<li><a href="https://pymotw.com/3/multiprocessing/">pymotw multiprocessing参考</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://china-testing.github.io/testing_training.html">自动化性能接口测试线上及深圳培训与项目实战 qq群：144081101 591302926</a></li>
                            <li><a href="http://blog.sciencenet.cn/blog-2604609-1112306.html">pandas数据分析scrapy爬虫 521070358 Py人工智能pandas-opencv 6089740</a></li>
                            <li><a href="http://blog.sciencenet.cn/blog-2604609-1112306.html">中医解梦看相八字算命qq群 391441566 csdn书籍下载-python爬虫 437355848</a></li>
                        </ul>
                </div><!-- /.blogroll -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>